# Audit log restore runbook

The System API records change history in the `audit_logs` table via database triggers installed by the initial Prisma migration. Each trigger calls the `record_audit()` PostgreSQL function to capture inserts, updates, and deletes along with the active application user (see `apps/system-api/prisma/migrations/0001_init/migration.sql`). Use this procedure to recover data from audit entries.

## When to run a restore

- A user deletes an entity unintentionally and no soft-delete exists.
- A schema migration corrupts a record and the original values are still present in audit history.

## Identify the source record

1. Determine the target table and record ID.
2. Query audit history in descending order:
   ```sql
   SELECT created_at, action, old_values, new_values
   FROM audit_logs
   WHERE table_name = 'customer_profiles' AND record_id = '...'
   ORDER BY created_at DESC;
   ```
3. Pick the last known-good row before the destructive action. For deletes, use the row where `action = 'DELETE'` and values are stored in `old_values`.

## Reapplying data

1. Export the JSONB payload you want to restore. Keys map to column names after Prisma field mapping (`schema.prisma`).
2. Build an explicit `UPDATE` statement (or `INSERT` for deleted records). Example:
   ```sql
   UPDATE customer_profiles
   SET display_name = payload->>'display_name', updated_at = NOW()
   WHERE customer_profiles_id = '...';
   ```
   Use `jsonb_populate_record` for complex shapes:
   ```sql
   UPDATE customer_profiles
   SET
     (display_name, contact_email) = (
       SELECT display_name, contact_email
       FROM jsonb_populate_record(NULL::customer_profiles, payload)
     ),
     updated_at = NOW()
   WHERE customer_profiles_id = '...';
   ```
3. Wrap changes in a transaction and document the incident in the on-call log.

## Rebuilding materialized caches

- After restoring customer, venue, or singer data, flush the relevant Redis keys so cached payloads pick up the changes. Refer to cache key formats in the corresponding services (e.g., `VenueService` caches venues under `customer:venues:<customerProfileId>`).
- For queue-driven workflows (stripe sync, song index refresh), re-enqueue jobs if downstream systems require reconciliation.

## Verification checklist

- The affected record appears correctly via the API.
- Audit log shows a new update generated by the manual fix (trigger re-runs during `UPDATE`).
- Related cache entries are repopulated without stale data.
